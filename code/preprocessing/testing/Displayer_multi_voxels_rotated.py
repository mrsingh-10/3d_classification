import sys
import os
from pathlib import Path
import open3d as o3d

# TO ADD preprocessing as module
path = Path(__file__)
while (path.stem != "code"):
    path = path.parent
sys.path.append(os.fspath(path.absolute()))

from preprocessing.HelperClass import HelperClass as Helper

import copy
import numpy as np
o3d.utility.set_verbosity_level(o3d.utility.VerbosityLevel.Error)

# PROBLEMS:
# NOT PRESENT: "table_0361"
# REMOVED UPPER PART of table_0116



# DEMO CALLS


def importMesh(path):
    # Importing mesh
    mesh = Helper.importMesh(path)
    # Scaling
    mesh.scale(max(mesh.get_max_bound() - mesh.get_min_bound()) /
               32, mesh.get_center())
    # mesh.compute_vertex_normals()
    return mesh


l = ["chair_0900", "chair_0902", "chair_0944", "chair_0952", "chair_0954",
     "chair_0980", "chair_0983", "chair_0986", "chair_0987", "chair_0989"]

# Importing mesh
path = l[0]
isTestModel = True
filename = Helper.getFullPathForModel(
    path, isTestModel, "ModelNet10", isMesh=True, hasRotaions=False)
mesh = importMesh(filename)
voxelGrid = Helper.getVoxelGridFromMesh(mesh)

maxRot = 12
v = []
i = 11
lookats = [
    [ 13.136383585692343, 12.06934386657889, 19.114219881500986 ], #0
    [ 5.3505686323592627, 17.035252490440556, 19.114219881500986 ], #1
    [ -3.8974006038418514, 17.436041531196267, 19.114219881500986 ], #2
    [ -12.06934386657889, 13.136383585692343, 19.114219881500986 ], #3
    [ -17.049913221792309, 5.3505686323592663, 19.114219881500986 ], #4
    [ -17.430251469121714, -3.8974006038418567, 19.114219881500986 ], #5
    [ -13.136383585692339, -12.06934386657889, 19.114219881500986 ], #6
    [ -5.3447785702847135, -17.049913221792309, 19.114219881500986 ],  # 7
    [ 3.8827398724900979, -17.430251469121714, 19.114219881500986 ],  # 8
    [ 12.06934386657889, -13.136383585692339, 19.114219881500986 ],  # 9
    [ 17.035252490440556, -5.3447785702846922, 19.114219881500986 ], # 10
    [ 17.436041531196267, 3.8827398724900979, 19.114219881500986 ], # 11
]

FIRST = True
for number in range(i, maxRot):
    v = []
    rotated = Helper.getVGRotated(voxelGrid, 32, rz=(number*2*np.pi/maxRot))
    v.append(rotated)

    # Showing mesh with BBs
    #0)
    # front = [ -0.0023697042582815206, -0.92643123904564739, 0.37645656299508823 ],
    # lookat = [ 13.136383585692343, 12.06934386657889, 19.114219881500986 ],
    # up = [ 0.013618291895706788, 0.37639281233461797, 0.92636007737201231 ],
    # zoom = 1.1928333333333332,

    #1)
			# "front" : [ 0.0, 0.0, 1.0 ],
			# "lookat" : [ 5.3505686323592627, 17.035252490440556, 19.114219881500986 ],
			# "up" : [ 0.0, 1.0, 0.0 ],
			# "zoom" : 0.69999999999999996
    # "front" : [ 0.0094433766910771086, -0.90605999222747025, 0.42304386666328958 ],
    # "lookat" : [ 5.3505686323592627, 17.035252490440556, 19.114219881500986 ],
    # "up" : [ -0.0075437666301593617, 0.42298613950456332, 0.90610474966863275 ],
    # "zoom" : 0.91033333333333277
    

    #2) [ -3.8974006038418514, 17.436041531196267, 19.114219881500986 ],
	
    # "front" : [ 0.01868553805159227, -0.94224954373586434, 0.33438996396016168 ],
    # "lookat" : [ -3.8974006038418514, 17.436041531196267, 19.114219881500986 ],
    # "up" : [ -0.0075270035637335624, 0.33430630758623858, 0.94243442049057546 ],
    # "zoom" : 0.93683333333333274

    # 3) [ -12.06934386657889, 13.136383585692343, 19.114219881500986 ],

    # "front" : [ -0.018497243299568037, -0.82593387011838537, 0.56346348078787034 ],
    # "lookat" : [ -12.06934386657889, 13.136383585692343, 19.114219881500986 ],
    # "up" : [ -0.0080618682875847249, 0.56366478633753059, 0.82596429397570192 ],
    # "zoom" : 0.69999999999999996

    # 4) [ -17.049913221792309, 5.3505686323592663, 19.114219881500986 ],
    # 5) [ -17.430251469121714, -3.8974006038418567, 19.114219881500986 ],
    # 6) [ -13.136383585692339, -12.06934386657889, 19.114219881500986 ],
    # 7) [ -5.3447785702847135, -17.049913221792309, 19.114219881500986 ],
    # 8) [ 3.8827398724900979, -17.430251469121714, 19.114219881500986 ],
    # 9) [ 12.06934386657889, -13.136383585692339, 19.114219881500986 ],
    # 10) [ 17.035252490440556, -5.3447785702846922, 19.114219881500986 ],
    # 11) [ 17.436041531196267, 3.8827398724900979, 19.114219881500986 ],
               
    front = [ 0.01868553805159227, -0.94224954373586434, 0.33438996396016168 ]
    lookat = lookats[i]
    up = [ -0.0075270035637335624, 0.33430630758623858, 0.94243442049057546 ]
    zoom = 1
    if FIRST:
        FIRST = False
        o3d.visualization.draw_geometries(v,
                                front = front,
                                lookat = lookat,
                                up = up,
                                zoom = zoom
                                  )
    else:
        #o3d.visualization.draw_geometries(v)
        exit()